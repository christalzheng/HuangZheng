---
title: "Determinants Influencing the Sex Ratio of Turtle Offspring"
author: "Yuechen Huang; Shiqi Zheng"
date: "Fall 2023"
output:
  html_document:
    df_print: paged
---

## Set up and Data Wrangling

```{r setup, message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(rotl)

Cleaned_Data <- read.csv(here("Processed/Cleaned_Data.csv"), 
                         stringsAsFactors = TRUE)
theme_yh <- theme_classic(base_size = 14) + 
  theme(axis.text = element_text(color = "black"),
  legend.position = "right",
  legend.text = element_text(size = 10),
  legend.title = element_text(size = 11),
  plot.title = element_text(size = rel(1.5)),
  axis.text.x = element_text(angle = 75, vjust = 1, hjust=1))
```

## Explore the species

### Phylogenetic tree

We used a "rotl" package to interact with the Open Tree of Life data (<https://doi.org/10.1111/2041-210X.12593>). First, we need to change the name of the species into something compatible with the package.

```{r generate phylogenetic tree, fig.height=10, fig.width=6, warning=FALSE}
Cleaned_Data$Species_names <- as.character(Cleaned_Data$Species)  # Convert factors to characters

# Replace underscores with spaces
Cleaned_Data$Species_names <- gsub("_", " ", Cleaned_Data$Species_names)

# Create a data frame that calculate the mean sex ratio of each species
Data_species <- Cleaned_Data %>% group_by(Species_names) %>%
  summarise(mean_sex_ratio = mean(Proportion_Male, na.rm = TRUE),
            SD_sex_ratio = sd(Proportion_Male, na.rm = TRUE),
            mean_humidity_sp = mean(Humidity, na.rm = TRUE),
            SD_humidity_sp = sd(Humidity, na.rm = TRUE),
            mean_temp_sp = mean(Mean_Temp, na.rm = TRUE),
            SD_temp_sp = sd(Mean_Temp, na.rm = TRUE)) 
write.csv(Data_species, file = here("Processed/Data_Species.csv"), row.names = FALSE) # Data regroup by species

# Create a data frame that calculate the mean sex ratio of each family
Data_families <- Cleaned_Data %>% group_by(Family) %>%
  summarise(mean_sex_ratio = mean(Proportion_Male, na.rm = TRUE),
            SD_sex_ratio = sd(Proportion_Male, na.rm = TRUE),
            mean_humidity = mean(Humidity, na.rm = TRUE),
            SD_humidity = sd(Humidity, na.rm = TRUE),
            mean_temp = mean(Mean_Temp, na.rm = TRUE),
            SD_temp = sd(Mean_Temp, na.rm = TRUE)) 
write.csv(Data_species, file = here("Processed/Data_Families.csv"), row.names = FALSE) # Data regroup by families

Data_species$taxa <- rotl::tnrs_match_names(Data_species$Species_names)
tree <- tol_induced_subtree(ott_ids = ott_id(Data_species$taxa))
collaped_tree <- ape::ladderize(ape::collapse.singles(tree, root.edge = FALSE)) ## tried to make this less messy but doesn't work
plot(collaped_tree, cex = .5, label.offset = .1, no.margin = TRUE)
```

### Tree map

Because there are too many species, the plot looks very messy...Then we can try to make a treemap instead (<https://r-graph-gallery.com/236-custom-your-treemap.html>).

```{r treemap}
library(ggplot2)
## install.packages("treemap")
# install.packages("remotes")
# remotes::install_github("d3treeR/d3treeR")
library(treemap)
library(d3treeR)

species_count <- count(Cleaned_Data, Order, Family, Genus, Species_names)
write.csv(species_count, file = here("Processed/Species_Count.csv"), row.names = FALSE) 

phytree <- treemap(species_count, 
        index = c("Order", "Family", "Genus", "Species_names"),
        vSize = "n",
        type = "index",
        vColor = "index",
        title="Species Occurance in the database",
        palette="Dark2",
        fontsize.labels=c(15,12,11,10),
        fontcolor.labels = c("White","Black","Grey","#ffce86"),
        fontface.labels=c(2,1,1,3),  
        bg.labels=c("transparent"), 
        overlap.labels= 0.15,
        inflate.labels= T,
        )

interactive_tree <- d3tree2(phytree, 
                            rootname = "Species Occurance in the database")
interactive_tree

# save the widget
library(htmlwidgets)
saveWidget(interactive_tree, file=paste0(here(), "/Processed/interactiveTreemap.html"))
```

From the tree maps (ggplot map and interactive tree map) we can see that all of the species are within Testudines Order. The most abundant family is Cheloniidae, Emydidae and Chelydridae. The species we have most in our database is Common snapping turtle (Chelydra serpentina) and Green sea turtle (Chelonia mydas) with a occurrence of 1123 and 881 records.

### Basic statistics about species

We will explore sex ratio and temperature data for different species respectively.

#### Sex ratio among families

First, we need to filter the data because we have too many species. Let's only focus on family level.

```{r stats}
ggplot(Cleaned_Data, aes(x = Family, y = Proportion_Male, 
                      fill = Family, 
                      label = Proportion_Male)) + 
  geom_boxplot(na.rm = TRUE) + theme_yh +
  scale_fill_brewer(palette="Set3") + 
  labs(x = "Family Names", y = "Sex ratio")
```

We want to explore whether there are significant difference in sex ratio between different families. We can use One-way ANOVA to analyse the data. First, we need to check the normality.

```{r anova family vs sex ratio normality check}
# check the normality of the data
shapiro.test(Cleaned_Data$Proportion_Male[Cleaned_Data$Family == "Carettochelyidae"])
shapiro.test(Cleaned_Data$Proportion_Male[Cleaned_Data$Family == "Cheloniidae"])
shapiro.test(Cleaned_Data$Proportion_Male[Cleaned_Data$Family == "Chelydridae"])
shapiro.test(Cleaned_Data$Proportion_Male[Cleaned_Data$Family == "Dermatemydidae"])
shapiro.test(Cleaned_Data$Proportion_Male[Cleaned_Data$Family == "Dermochelyidae"])
shapiro.test(Cleaned_Data$Proportion_Male[Cleaned_Data$Family == "Emydidae"])
shapiro.test(Cleaned_Data$Proportion_Male[Cleaned_Data$Family == "Geoemydidae"])
shapiro.test(Cleaned_Data$Proportion_Male[Cleaned_Data$Family == "Kinosternidae"])
shapiro.test(Cleaned_Data$Proportion_Male[Cleaned_Data$Family == "Pelomedusidae"])
shapiro.test(Cleaned_Data$Proportion_Male[Cleaned_Data$Family == "Podocnemididae"])
shapiro.test(Cleaned_Data$Proportion_Male[Cleaned_Data$Family == "Testudinidae"])
shapiro.test(Cleaned_Data$Proportion_Male[Cleaned_Data$Family == "Trionychidae"])

```

Apart from Dermatemydidae and Trionychida, all data follows a normal distribution. We then check equality of variance.

```{r test for equal variance}
bartlett.test(Cleaned_Data$Proportion_Male, Cleaned_Data$Family)
```

We can reject the null (P = 3.903e-08) i.e. variances are not equal.

```{r anova test}
family.sex.anova <- aov(data = Cleaned_Data, Proportion_Male ~ Family)
summary(family.sex.anova)
plot(family.sex.anova)
TukeyHSD(family.sex.anova)
```

From the results, we can see that there is a significant difference in sex ratio among families. Emydidae-Cheloniidae, Emydidae-Chelydridae and Pelomedusidae-Emydidae are the groups that show significant difference (p \< 0.05).

#### Temperature among families

```{r temp}
ggplot(Cleaned_Data, aes(x = Family, y = Mean_Temp, 
                      fill = Family, 
                      label = Mean_Temp)) + 
  geom_boxplot(na.rm = TRUE) + theme_yh +
  scale_fill_brewer(palette="Set3") + 
  labs(x = "Family Names", y = expression("Hatching Temperature ("*~degree*C*")")) 
```

Hatching temperature among all the families are around 25 - 35 degree Celsius. Emydidae has a high variance of hatching temperature for different individuals or communities. We want to see whether there is significant difference in Hatching temperature among families. Let's check normality first.

```{r normality family vs temp}
shapiro.test(Cleaned_Data$Mean_Temp[Cleaned_Data$Family == "Carettochelyidae"])
shapiro.test(Cleaned_Data$Mean_Temp[Cleaned_Data$Family == "Cheloniidae"])
shapiro.test(Cleaned_Data$Mean_Temp[Cleaned_Data$Family == "Chelydridae"])
shapiro.test(Cleaned_Data$Mean_Temp[Cleaned_Data$Family == "Dermatemydidae"])
shapiro.test(Cleaned_Data$Mean_Temp[Cleaned_Data$Family == "Dermochelyidae"])
shapiro.test(Cleaned_Data$Mean_Temp[Cleaned_Data$Family == "Emydidae"])
shapiro.test(Cleaned_Data$Mean_Temp[Cleaned_Data$Family == "Geoemydidae"])
shapiro.test(Cleaned_Data$Mean_Temp[Cleaned_Data$Family == "Kinosternidae"])
shapiro.test(Cleaned_Data$Mean_Temp[Cleaned_Data$Family == "Pelomedusidae"])
shapiro.test(Cleaned_Data$Mean_Temp[Cleaned_Data$Family == "Podocnemididae"])
shapiro.test(Cleaned_Data$Mean_Temp[Cleaned_Data$Family == "Testudinidae"])
# shapiro.test(Cleaned_Data$Mean_Temp[Cleaned_Data$Family == "Trionychidae"]) Trionychidae doesn't have enough data (n<3) so we can just delete it.
```

The null hypothesis of Cheloniidae, Chelydridae, Dermochelyidae, Emydidae, Geoemydidae, Kinosternidae can be rejected.

```{r test for equal variance}
bartlett.test(Cleaned_Data$Mean_Temp, Cleaned_Data$Family)
```

We can reject the null (P = \<2.2e-16) i.e. variances are not equal.

```{r anova test}
family.temp.anova <- aov(data = Cleaned_Data, Mean_Temp ~ Family)
summary(family.temp.anova)
plot(family.temp.anova)
TukeyHSD(family.temp.anova)
```

There is significant difference in hatching temperature among families (F = 184.5, P \<2e-16).

\newpage

## Explore data position

sorce: <https://hub.arcgis.com/datasets/COAGIS>::world-continents/explore?location=-0.634214%2C0.000000%2C2.09

```{r map}
library(sf)
library(mapview); mapviewOptions(fgb = FALSE)

# load data
world_continent<- st_read(here('Raw/World_Continents/World_Continents.shp')) 
data_sf <- cleaned_data %>%
  filter(!is.na(cleaned_data$Longitude)) %>% 
  st_as_sf(coords = c('Longitude','Latitude'),
          crs=4326) #WGS84
# select data
wild_data_sf <- data_sf %>%
  filter(Captive=='0')
captive_data_sf <- data_sf %>%
  filter(Captive=='1')
other_data_sf <- data_sf %>%
  filter(is.na(Captive))
  
# plot map
#mapview(world_continent,col.regions='grey', alpha.regions = 0.3)+
  #mapview(wild_data_sf,col.regions='blue', alpha=0.1 , cex =5, layer.name='Wild')+
  #mapview(captive_data_sf,col.regions='red',alpha = 0.1, cex =5, layer.name='Captive')

ggplot()  +
  geom_sf(data = world_continent, aes(fill='grey'),show.legend = "polygon") +
  geom_sf(data = wild_data_sf, aes(color='blue'), alpha=0.1, cex =3, show.legend = "point") +
  geom_sf(data = captive_data_sf, aes(color='red'), alpha=0.1 , cex =3) +
  geom_sf(data = other_data_sf, aes(color='darkgrey'), alpha=0.1 , cex =3)+
  labs(title = "Distribution of data") +
  scale_fill_manual(labels = c("World Continent"),
                    name = NULL,
                    values = c("grey" = 'grey'), 
                    guide = guide_legend(override.aes = list(linetype = "blank", shape = NA))) +
  scale_colour_manual(name = "Data Type",
                      labels = c("Wild","Captive", "Other"),
                      values = c("blue" = "blue", 'red'='red','darkgrey'='darkgrey'),
                      guide = guide_legend(override.aes = list(linetype =  "blank"), 
                                                               shape = c(16, NA))) 
```
