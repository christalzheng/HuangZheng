---
title: "Determinants Influencing the Sex Ratio of Turtle Offspring"
subtitle: "https://github.com/christalzheng/HuangZheng"
author: "Yuechen Huang; Shiqi Zheng"
date: "Fall 2023"
output: pdf_document
toc: yes
---
\newpage
[A cute baby sea turtle](../Output/Baby Sea Turtles.jpeg){width="30%"}

\tableofcontents 
\listoftables 
\listoffigures 

\newpage

```{r setup, include=FALSE}
# Load your packages
library(tidyverse)
library(here)
library(lubridate)
library(rotl)
library(sf)
library(mapview); mapviewOptions(fgb = FALSE)
library(stats)

# Set your ggplot theme
theme_yh <- theme_classic(base_size = 14) + 
  theme(axis.text = element_text(color = "black"),
  legend.position = "right",
  legend.text = element_text(size = 10),
  legend.title = element_text(size = 11),
  plot.title = element_text(size = rel(1.5)),
  axis.text.x = element_text(angle = 75, vjust = 1, hjust=1))

# Load your datasets
Database <- read.csv(here("Data/Raw/ROSIE/Database.csv"), stringsAsFactors = TRUE)
```

```{r data wrangling, include=FALSE}
cleaned_data <- Database %>% 
  filter(is.na(Chemical_Concentration)) %>% # don't want chemical treatment
  filter(!is.na(Proportion_Male)) %>% # we want to rows that have proportion_male data
  filter(SDM == 'TSD') %>% # we want to focus on turtles that are TSD
  select(Order, Family, Genus, Species, 
         Mean_Temp,Mean_Temp_SD, 
         Latitude, Longitude, Captive, Humidity, 
         First_Year, First_Month, Last_Year, Last_Month,
         Proportion_Male, Proportion_Female) 
  # the term "sex-ratio" is misleading -> abondon, just use male proportion
  #mutate(Sex_ratio = Proportion_Male / Proportion_Female) %>% 
 # mutate(Sex_ratio = ifelse(is.infinite(Sex_ratio), 1, Sex_ratio)) %>% # 0/1 -> 0 - all female, 1 -> female = male, 1/0 -> infinite -> all male
  # filter(!is.nan(Sex_ratio)) # we found there are some NaN and infinite data in sex ratio column, we may need to filter these data out  

# Deal with date
cleaned_data$Start_Date <- as.Date(paste(cleaned_data$First_Year, 
                                         cleaned_data$First_Month,
                                         "01", sep = "-"))
cleaned_data$End_Date <- as.Date(paste(cleaned_data$Last_Year, 
                                         cleaned_data$Last_Month,
                                         "01", sep = "-"))

# re-select column we need
cleaned_data <- select(cleaned_data, Order, Family, Genus, Species,
                       Mean_Temp,Mean_Temp_SD,
                       Latitude, Longitude, Captive, Humidity, 
                       Start_Date, End_Date, Proportion_Male, Proportion_Female)

# create a cleaned data in processed folder
write.csv(cleaned_data, file = here("Data/Processed/Cleaned_Data.csv"), row.names = FALSE)

Cleaned_Data <- read.csv(here("Data/Processed/Cleaned_Data.csv"), 
                         stringsAsFactors = TRUE)
```

# 1  Rationale and Research Questions

In the majority of species, sex is determined during fertilization; however, reptiles likw turtles, alligators, and crocodiles exhibit a unique characteristic where sex determination occurs after fertilization. This process is known as temperature-dependent sex determination (TSD). In TSD, the sex of offspring is influenced by the temperatures experienced during egg incubation in the nest.

Our project is motivated by a keen interest in understanding TSD, particularly in turtles. While TSD was first described in a lizard, the order Testudines has played an important role in advancing scientists' understanding of TSD. Studies on species within Testudines brought TSD to the attention of the broader research community, and the term "temperature-dependent sex determination" also first appeared in a study of a community of North American turtles in 1979 (Yntema, 1976; Bull and Vogt, 1979).

We aim to test the TSD phenomenon by ourselves with a focus and thus choose to investigate a dataset containing plenty sex ratio information for the order Testudines. We will explore the following questions: 1. Does temperature affect the sex ratio of turtles? If so, how does temperature influence the sex ratio of turtles? 2. Is temperature the sole determinant of turtle sex, or are there other important factors?


# 2  Dataset Information

We use a dataset called Reptilian Offspring Sex and Incubation Environment (ROSIE). It is a dataset published in 2022 and contains over 7,000 individual measurements of offspring sex ratios in the order Testudines as well as SDM classifications for 149 species. This dataset obtained data by using the Web of Science to search for research published since the discovery of TSD (1966) until 31 December 2020.

We processed the original dataset by omitting all data has been chemical treatment, selecting all TSD type data, all point contains male proportion data, converting date value to date object, and selecting all species information, mean temperature, latitude, longitude, captive, humidity, start date, end date, proportion male, and proportion female as the variables we will explore with.

Variables we used and wrangled for this project are shown in Table 1. More information about the ROSIE Dataset can be found at: <https://github.com/calebkrueger/ROSIE/tree/main>

Table: Summary of Dataset

| Used Variables      | Details                                                                            |
|:-----------------------------------|:-----------------------------------|
| Species information | Order, Family, Genus, Species                                                          |
| Spatial information | Wild sampling location, or native range of species if captive or location not provided, Provided in average latitude and longitude|
| Captivity           | Eggs from captive or/and wild individuals, 0 - wild and 1 - captive                    |
| Time                | Time of turtle nesting/egg collection. Provided in start date and end date                                                  |
| Temperature         | Mean of actual/recorded incubator temperature in degrees Celsius                       |
| Humidity            | Relative humidity of incubation chamber between 0 and 1                                |
| Sex ratio           | Proportion of male,                                                                    |

\newpage

# 3  Exploratory Analysis

To have a better understanding of our data, we explore the distribution of different turtle species, variations in hatching temperatures and sex ratio across diverse turtle families, and distribution of data location.

## 3.1  Explore the species in the dataset
We want to use a "rotl" package to interact with the Open Tree of Life data (<https://doi.org/10.1111/2041-210X.12593>). First, we need to change the name of the species into something compatible with the package.

```{r generate phylogenetic tree, fig.height=10, fig.width=6, warning=FALSE, fig.cap="Phylogenetic tree of species in our database"}
Cleaned_Data$Species_names <- as.character(Cleaned_Data$Species)  # Convert factors to characters

# Replace underscores with spaces
Cleaned_Data$Species_names <- gsub("_", " ", Cleaned_Data$Species_names)

# Create a data frame that calculate the mean sex ratio of each species
Data_species <- Cleaned_Data %>% group_by(Species_names) %>%
  summarise(mean_sex_ratio = mean(Proportion_Male, na.rm = TRUE),
            SD_sex_ratio = sd(Proportion_Male, na.rm = TRUE),
            mean_humidity_sp = mean(Humidity, na.rm = TRUE),
            SD_humidity_sp = sd(Humidity, na.rm = TRUE),
            mean_temp_sp = mean(Mean_Temp, na.rm = TRUE),
            SD_temp_sp = sd(Mean_Temp, na.rm = TRUE)) 
write.csv(Data_species, file = here("Data/Processed/Data_Species.csv"), row.names = FALSE) # Data regroup by species

# Create a data frame that calculate the mean sex ratio of each family
Data_families <- Cleaned_Data %>% group_by(Family) %>%
  summarise(mean_sex_ratio = mean(Proportion_Male, na.rm = TRUE),
            SD_sex_ratio = sd(Proportion_Male, na.rm = TRUE),
            mean_humidity = mean(Humidity, na.rm = TRUE),
            SD_humidity = sd(Humidity, na.rm = TRUE),
            mean_temp = mean(Mean_Temp, na.rm = TRUE),
            SD_temp = sd(Mean_Temp, na.rm = TRUE)) 
write.csv(Data_species, file = here("Data/Processed/Data_Families.csv"), row.names = FALSE) # Data regroup by families

Data_species$taxa <- rotl::tnrs_match_names(Data_species$Species_names)
tree <- tol_induced_subtree(ott_ids = ott_id(Data_species$taxa))
collaped_tree <- ape::ladderize(ape::collapse.singles(tree, root.edge = FALSE)) ## tried to make this less messy but doesn't work
plot(collaped_tree, cex = .5, label.offset = .1, no.margin = TRUE)
```

Though the phylogeny tree clearly showed the relationship between species. The species are too much to explore, we want to make a treemap as well (<https://r-graph-gallery.com/236-custom-your-treemap.html>).

```{r treemap, fig.cap="Tree map of species in our database"}
library(ggplot2)
## install.packages("treemap")
# install.packages("remotes")
# remotes::install_github("d3treeR/d3treeR")
library(treemap)
library(d3treeR)

species_count <- count(Cleaned_Data, Order, Family, Genus, Species_names)
write.csv(species_count, file = here("Data/Processed/Species_Count.csv"), row.names = FALSE) 

phytree <- treemap(species_count, 
        index = c("Order", "Family", "Genus", "Species_names"),
        vSize = "n",
        type = "index",
        vColor = "index",
        title="Species Occurance in the database",
        palette="Dark2",
        fontsize.labels=c(15,12,11,10),
        fontcolor.labels = c("White","Black","Grey","#ffce86"),
        fontface.labels=c(2,1,1,3),  
        bg.labels=c("transparent"), 
        overlap.labels= 0.15,
        inflate.labels= T,
        )

interactive_tree <- d3tree2(phytree, 
                            rootname = "Species Occurance in the database")
# save the widget
library(htmlwidgets)
saveWidget(interactive_tree, file=paste0(here(), "/Data/Processed/interactiveTreemap.html"))
```

You can view the interactive tree map using the link below. 
[Interactive Tree Map](../Data/Processed/interactiveTreemap.html)

From the tree maps (ggplot map and interactive tree map) we can see that all of the species are within Testudines Order. The most abundant family is Cheloniidae, Emydidae and Chelydridae. The species we have most in our database is Common snapping turtle (Chelydra serpentina) and Green sea turtle (Chelonia mydas) with a occurrence of 1123 and 881 records.


## 3.2  Explore hatching temperature among families
```{r temp, fig.cap="Box plot of temperature among families"}
ggplot(Cleaned_Data, aes(x = Family, y = Mean_Temp, 
                      fill = Family, 
                      label = Mean_Temp)) + 
  geom_boxplot(na.rm = TRUE) + theme_yh +
  scale_fill_brewer(palette="Set3") + 
  labs(x = "Family Names", y = expression("Hatching Temperature ("*~degree*C*")")) 
```

Hatching temperature among all the families are around 25 - 35 degree Celsius. Emydidae has a high variance of hatching temperature for different individuals or communities. We want to see whether there is significant difference in hatching temperature among families. Let's check normality first.

```{r normality family vs temp}
shapiro.test(Cleaned_Data$Mean_Temp[Cleaned_Data$Family == "Carettochelyidae"])
shapiro.test(Cleaned_Data$Mean_Temp[Cleaned_Data$Family == "Cheloniidae"])
shapiro.test(Cleaned_Data$Mean_Temp[Cleaned_Data$Family == "Chelydridae"])
shapiro.test(Cleaned_Data$Mean_Temp[Cleaned_Data$Family == "Dermatemydidae"])
shapiro.test(Cleaned_Data$Mean_Temp[Cleaned_Data$Family == "Dermochelyidae"])
shapiro.test(Cleaned_Data$Mean_Temp[Cleaned_Data$Family == "Emydidae"])
shapiro.test(Cleaned_Data$Mean_Temp[Cleaned_Data$Family == "Geoemydidae"])
shapiro.test(Cleaned_Data$Mean_Temp[Cleaned_Data$Family == "Kinosternidae"])
shapiro.test(Cleaned_Data$Mean_Temp[Cleaned_Data$Family == "Pelomedusidae"])
shapiro.test(Cleaned_Data$Mean_Temp[Cleaned_Data$Family == "Podocnemididae"])
shapiro.test(Cleaned_Data$Mean_Temp[Cleaned_Data$Family == "Testudinidae"])
# shapiro.test(Cleaned_Data$Mean_Temp[Cleaned_Data$Family == "Trionychidae"]) Trionychidae doesn't have enough data (n<3) so we can just delete it.
```

The null hypothesis of Cheloniidae, Chelydridae, Dermochelyidae, Emydidae, Geoemydidae, Kinosternidae can be rejected. Thus, Cheloniidae, Chelydridae, Dermochelyidae, Emydidae, Geoemydidae, Kinosternidae are normally distributed.

```{r test for equal variance temp}
bartlett.test(Cleaned_Data$Mean_Temp, Cleaned_Data$Family)
```

We can also reject the null hypothesis of bartlett test (P = <2.2e-16) i.e. variances are not equal.

```{r anova test temp among families}
family.temp.anova <- aov(data = Cleaned_Data, Mean_Temp ~ Family)
summary(family.temp.anova)
plot(family.temp.anova)
TukeyHSD(family.temp.anova)
```

There is significant difference in hatching temperature among families (F = 184.5, P <2e-16). The result corresponds with the box plot we made above. This variation of temperature among families can be due to the genetic variation or the difference in population extinction status.


## 3.3  Explore sex ratio among families

```{r stats, fig.cap="Box plot of sex ratio among families"}
ggplot(Cleaned_Data, aes(x = Family, y = Proportion_Male, 
                      fill = Family, 
                      label = Proportion_Male)) + 
  geom_boxplot(na.rm = TRUE) + theme_yh +
  scale_fill_brewer(palette="Set3") + 
  labs(x = "Family Names", y = "Sex ratio")
```

The sex ratio seems to vary among different families. Pelomedusidae, Cheloniidae, Chelydridae, Dermochelyidae, Kinosternidae have a mean average sex ratio that is lower than 0.5. Trionychidae has a sex ratio that is clearly greater than 0.5. These families may suffer from species extinction because of the unbalanced population. All the families have very high variance. This may be because of the shortage of data (so that extreme values can have more impact on the total data). This indicates the necessity of having more conservation effort in data collection or population management.

We want to explore whether there are significant differences in sex ratio between different families. We can use One-way ANOVA to analyse the data. First, we need to check the normality.

```{r anova family vs sex ratio normality check}
# check the normality of the data
shapiro.test(Cleaned_Data$Proportion_Male[Cleaned_Data$Family == "Carettochelyidae"])
shapiro.test(Cleaned_Data$Proportion_Male[Cleaned_Data$Family == "Cheloniidae"])
shapiro.test(Cleaned_Data$Proportion_Male[Cleaned_Data$Family == "Chelydridae"])
shapiro.test(Cleaned_Data$Proportion_Male[Cleaned_Data$Family == "Dermatemydidae"])
shapiro.test(Cleaned_Data$Proportion_Male[Cleaned_Data$Family == "Dermochelyidae"])
shapiro.test(Cleaned_Data$Proportion_Male[Cleaned_Data$Family == "Emydidae"])
shapiro.test(Cleaned_Data$Proportion_Male[Cleaned_Data$Family == "Geoemydidae"])
shapiro.test(Cleaned_Data$Proportion_Male[Cleaned_Data$Family == "Kinosternidae"])
shapiro.test(Cleaned_Data$Proportion_Male[Cleaned_Data$Family == "Pelomedusidae"])
shapiro.test(Cleaned_Data$Proportion_Male[Cleaned_Data$Family == "Podocnemididae"])
shapiro.test(Cleaned_Data$Proportion_Male[Cleaned_Data$Family == "Testudinidae"])
shapiro.test(Cleaned_Data$Proportion_Male[Cleaned_Data$Family == "Trionychidae"])

```

Apart from Dermatemydidae and Trionychida, all data follows a normal distribution. We then check equality of variance.

```{r test for equal variance sex ratio}
bartlett.test(Cleaned_Data$Proportion_Male, Cleaned_Data$Family)
```

We can reject the null hypothesis (P = 3.903e-08) i.e. variances are not equal.

```{r anova test sex ratio among families}
family.sex.anova <- aov(data = Cleaned_Data, Proportion_Male ~ Family)
summary(family.sex.anova)
plot(family.sex.anova)
TukeyHSD(family.sex.anova)
```

From the results, we can see that there is a significant difference in sex ratio among families. Emydidae-Cheloniidae, Emydidae-Chelydridae and Pelomedusidae-Emydidae are the groups that show significant difference (p < 0.05). The reason could be that the three families are more genetically different from each other than other families.


## 3.4  Explore data position

The location of wild sampling points, or the native range of species if captive, is plotted below as a map to show the spatial distribution of data. The world continent data is downloaded from ArcGIS database.

```{r explore location 1, include=FALSE}
# load data
world_continent<- st_read(here('Data/Raw/World_Continents/World_Continents.shp')) 
data_sf <- cleaned_data %>%
  filter(!is.na(cleaned_data$Longitude)) %>% 
  st_as_sf(coords = c('Longitude','Latitude'),
          crs=4326) #WGS84
```

```{r explore location, echo=FALSE, fig.cap="Spatial distribution of data"}
# select data
wild_data_sf <- data_sf %>%
  filter(Captive=='0')
captive_data_sf <- data_sf %>%
  filter(Captive=='1')
other_data_sf <- data_sf %>%
  filter(is.na(Captive))
  
# plot map
#mapview(world_continent,col.regions='grey', alpha.regions = 0.3)+
  #mapview(wild_data_sf,col.regions='blue', alpha=0.1 , cex =5, layer.name='Wild')+
  #mapview(captive_data_sf,col.regions='red',alpha = 0.1, cex =5, layer.name='Captive')

ggplot()  +
  geom_sf(data = world_continent, aes(fill='grey'),show.legend = "polygon") +
  geom_sf(data = wild_data_sf, aes(color='blue'), alpha=0.1, cex =3, show.legend = "point") +
  geom_sf(data = captive_data_sf, aes(color='red'), alpha=0.1 , cex =3,show.legend = "point") +
 #geom_sf(data = other_data_sf, aes(color='darkgrey'), alpha=0.1 , cex =3, show.legend = "point")+
  labs(title = "Distribution of data") +
  scale_fill_manual(labels = c("World Continent"),
                    name = NULL,
                    values = c("grey" = 'grey'), 
                    guide = guide_legend(override.aes = list(linetype = "blank", shape = NA))) +
  scale_colour_manual(name = "Data Type",
                      labels = c("Wild","Captive", "Other"),
                      values = c("blue" = "blue",'red'='red', 'darkgrey'='darkgrey'),
                      guide = guide_legend(override.aes = list(linetype =  "blank"), 
                                                               shape = c(16, NA))) 
```

\newpage

# 4  Analysis

## 4.1  Question 1: Does temperature affect the sex ratio of turtles? 
To answer that question, we first want to visually inspect the influence of temperature on sex ratio. Here, we created a scatter plot with a smooth lines showing the trend. We fitted a linear regression line in orange to the plot.
```{r scatter plot, fig.cap="Scatter plot of temperature and sex ratio"}
Data_omit <- filter(Cleaned_Data, !is.na(Cleaned_Data$Mean_Temp))
ggplot(Data_omit, aes(x = Mean_Temp, y = Proportion_Male)) + 
  geom_point() + geom_smooth(method=lm , color= "#f5924c", se= F) + 
  theme_yh + labs(x = expression("Hatching Temperature ("*~degree*C*")"), 
                  y = "Sex Ratio", title = "Temperature and Sex Ratio")
```

The linear trend can be seen on the scatter plot. As temperature increases, the sex ratio decreases. This trend corresponds to our expectation as higher temperature may lead to more female population. Yet, a more sophisticated linear regression analysis is still needed to be assured. 

Null Hypothesis: There is no effect of temperature on the sex ratio of turtles.
Alternative Hypothesis: There is an effect of temperature on the sex ratio of turtles.

Sex ratio in our research is defined as male proportion ranging from 0 to 1. The plots are shown below. 

```{r lm, echo=FALSE, fig.cap="Linear regression of temperature and sex ratio"}
tempSex.regression <- lm(
  data = Data_omit,
  Proportion_Male ~ Mean_Temp)
summary(tempSex.regression)

par(mfrow = c(2,2), mar=c(4,4,4,4))
plot(tempSex.regression)
```

We find that R-squared value is 0.1606 which is pretty low meaning that only a small proportion of data can be explained by this linear regression model. However, we still assured that temperature has a great impact on sex ratio after rejecting the null hypothesis (P < 2e-16). 

### 4.1.1  How does temperature influence the sex ratio of turtles?
After some literature reviews, we learned the relationship of temperature and sex ratio shown in the table above. When temperature is between 28 to 32 °C, the sex ratio (male proportion in our study) is approximately 0.5. Temperature below 28 °C results in a higher proportion of male while temperature above 32 °C leads to more female. 

We can see from the scattered plot that from 28 - 32 degree Celsius, the number of points that lay around 0.5 increases. This result corresponds to the other TSD research shown in the table. 

Table: Temperature-Sex Ratio Relationship

| Temperature      | Sex Ratio                                            |
|:-----------------------------------|:-----------------------------------|
| > 32°C   | Female                                                       |
| 28-32 °C | Male:Female ~ 50:50                                          |
| < 28°C   | Male                                                         |

### 4.1.2 Does the impact of temperature on sex ratio differentiate among families?
We also want to visualize the impact of temperature on sex ratio among species. Bubble plot seems to be a great option. 

```{r bubble plot, echo=FALSE, fig.height=5, fig.width=6, fig.cap="The impact of temperature on sex ratio among families"}
Data_family_temp <- select(Data_omit, Family, Mean_Temp, Proportion_Male)
ggplot(Data_family_temp, aes(x=Family, y=Mean_Temp, size = Proportion_Male, color = Family)) +
    geom_point(alpha=0.6) + scale_color_brewer(palette="Set3") + theme_yh +
  labs(y = expression("Hatching Temperature ("*~degree*C*")")) + 
  scale_size(name="Sex ratio")
```
We can see that the impact of temperature on sex ratio exists among most of the families including Carettochelyidae, Cheloniidae, Dermatemydidae, Geoemydidae, Kinosternidae, Podocnemididae and Testudinidae. We can see from the graph that As the temperature goes higher, the sex ratio of these families goes lower. 

Instead, Chelydridae, Dermochelyidae, Emydidae and Pelomedusidae have a trend that when temperature is lower than a certain value, sex ratio becomes higher as the temperature goes higher. Yet, when temperature is higher than a certain value, the trend reverses.

## 4.2   Question 2: Are there other important factors influence sex ratio of turtles?

To answer this question, we explore the impacts of temporal and spatial variation on the sex ratio of turtles. 

### 4.2.1  Temporal impacts

#### At Year Level

Null Hypothesis: There is no effect of year on the sex ratio of turtles.
Alternative Hypothesis: There is an effect of year on the sex ratio of turtles.

Based on the linear model, we rejects the null hypothesis with a p value of 2.873e-16. This p-value also shows this model is statistically significant and a meaningful regression. But according to the R^2 value, only 1.495% of the total variance in sex ratio is explained by changes in year. The sex ratio is predicted to increase 0.0041539 with 1 year change. The results of model are clearly showed in Figure 
The blue line shows a overall slightly increasing trend between year and sex ratio, indicating that as time passed by there are more male turtles. This is contradicts with our intuition that time increases will cause temperature increases and thus will lead to more female turtles. But because temperature trends might not be strictly linear or may be influenced by other factors in long term scenario, and the very noisy scatter plot and low R^2 value both show that this pattern only explain limited part of data, the linear model results of year and sex ratio is still statistically significant and a meaningful regression.

Below is results of linear model and scatter plot of year and sex ratio.

```{r year lm, echo=FALSE, fig.cap="Year and sex ratio relationship", out.width="90%"}
# Year
Cleaned_Data_omit <- filter(Cleaned_Data, !is.na(Cleaned_Data$End_Date))
Cleaned_Data_omit$End_Date <- as.Date(Cleaned_Data_omit$End_Date)
Cleaned_Data_omit$Year <- as.numeric(format(Cleaned_Data_omit$End_Date, "%Y"))
# data are mainly between 1980 - 2020
Cleaned_Data_omit <- filter(Cleaned_Data_omit, Year >= 1980 & Year <= 2020)

# lm
temp_lm <- lm(data = Cleaned_Data_omit, Proportion_Male ~ Year)
summary(temp_lm)

# visualize
ggplot(Cleaned_Data_omit, aes(x = Year, y = Proportion_Male)) + 
  geom_point() + 
  geom_smooth(method=lm , color="blue", se=TRUE) +
  theme_yh + 
  labs(x = "Year", y = "Sex Ratio", title = "Year and Sex Ratio Relationship")
```

#### At Month Level

Null Hypothesis: There is no effect of month on the sex ratio of turtles.
Alternative Hypothesis: There is an effect of month on the sex ratio of turtles.

Based on the linear model, we rejects the null hypothesis with a p value of 2.2e-16. But according to the R^2 value, only 2.857% of the total variance in sex ratio is explained by changes in month. 7 of the 12 months had p-values of less than 0.05, with April, June, August, September, and December being the exception. The p-values of the statistically significant month ranged from < 2e-16 (January) to 0.01576 (February). The impacts of month may be influences by spatial location and local climate. In order to explore monthly sex ratio distribution more clearly, we use box plot to show sex ratio by month for north hemisphere and south hemisphere respectively. The box plot for the north hemisphere clearly shows a trend of more male during colder season (November to April) and female during hotter season (May to October). This result is aligned with conclusion from Question 1 that higher temperature will cause more female turtles. The monthly distribution trend of sex ratio is not clearly for south hemisphere. This maybe because of lack of data in south hemisphere. But the highest proportion of male still appear in the colder season (July and August), and the rest of months all have less than 50% of male. Generally, the month impacts on sex ratio of turtles may also be influenced by the existence of breeding season.

Below is results of linear model and box plots of sex ratio by month for different hemispheres.

```{r month lm, echo=FALSE, fig.cap="Sex ratio value distribution by month for north hemisphere", out.width="90%"}
# Month
Cleaned_Data_omit$Month <- factor(format(Cleaned_Data_omit$End_Date, "%b"),levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) 

#lm
temp_lm_mon <- lm(data = Cleaned_Data_omit, Proportion_Male ~ Month)
summary(temp_lm_mon)

# North
Cleaned_Data_North <- filter(Cleaned_Data_omit, Latitude > 0)
ggplot(Cleaned_Data_North, aes(x = Month, y = Proportion_Male)) +
  geom_boxplot(fill = "lightblue") +
  theme_minimal() +
  labs(x = "Month", y = "Sex Ratio", title = "Boxplot of Sex Ratio by Month for North Hemisphere")
```


```{r month lm 2, echo=FALSE, fig.cap="Sex ratio value distribution by month for south hemisphere", out.width="90%"}
# South
Cleaned_Data_South <- filter(Cleaned_Data_omit, Latitude < 0)
ggplot(Cleaned_Data_South, aes(x = Month, y = Proportion_Male)) +
  geom_boxplot(fill = "lightblue") +
  theme_minimal() +
  labs(x = "Month", y = "Sex Ratio", title = "Boxplot of Sex Ratio by Month for South Hemisphere")
```

\newpage

### 4.2.2  Spatial impacts

We created a map to visualize the spatial impact on the sex ratio of turtles. However, it was difficult to identify any distinctive spatial pattern of sex ratio distribution from the map alone. However, after combining the temperature data with the sex ratio distribution, we were able to observe that the distribution of sex ratio is influenced by the temperature at different positions. The results from the map are consistent with the findings from Question 1 that location with lower temperature will have higher male proportion.

```{r Spatial, echo=FALSE, fig.cap="Sex ratio distribution on map", out.width="99%"}
ggplot() +
  geom_sf(data = world_continent,fill='grey') +
  geom_sf(data = data_sf, aes(color= Proportion_Male), size=3) +
  scale_color_gradient(low = "pink", high = "lightblue") + # 0 - all female, 1 - all male
  labs(title = "Sex Ratio Distribution", color = "Male Proportion")

```


```{r Spatial 2, echo=FALSE, fig.cap="Sex ratio distribution with temperature on map", out.width="99%"}
data_sf_temp <- filter(data_sf, !is.na(data_sf$Mean_Temp))
ggplot() +
  geom_sf(data = world_continent,fill='grey') +
  #geom_sf(data = data_sf_temp, aes(label = round(Proportion_Male, 1)), size = 1) +
  geom_sf(data = data_sf_temp, aes(color= Mean_Temp, size=Proportion_Male)) +
  scale_color_gradient(low = "white", high = "red") + 
  scale_size_continuous(range = c(1,4))+
  labs(title = "Sex Ratio Distribution", color = "Temparatue", size = "Male Proportion")
  #geom_sf_text(
   # data = data_sf_temp[data_sf_temp$Proportion_Male > 0.95 | data_sf_temp$Proportion_Male < 0, ],
   # aes(label = round(Proportion_Male, 1)),
   # size = 3,
    #check_overlap = TRUE,
    #hjust = 1.4)
```

\newpage

### 4.2.3  Best set of explanatory variables

Though month and year do have effects on the sex ratio of turtles, the trend between time and sex ratio may be confounded by the trend between time and temperature. We then want to explore what are best set of variables for sex ratio determinants. Thus, we run an AIC analysis to determine what set of explanatory variables is best suited to influence sex ratio. We use date data to provides the most detailed temporal information, including day, month, and year, which can capture fine-grained temporal patterns. The result form AIC shows that temperature alone is the best explanatory variables for the sex ratio of turtles. This result may be able to improve by having more valid data as there is only 63 observations due to limited amount of humidity data. Below is the detail of model results.

```{r multi factors, echo=FALSE}
# for all factors
# remove all NA
Cleaned_Data_remove <- Cleaned_Data_omit %>% 
  filter(!is.na(End_Date)) %>% 
  filter(!is.na(Humidity)) 

AIC <- lm(data = Cleaned_Data_remove, Proportion_Male ~ Mean_Temp + End_Date + Humidity + Captive)
step(AIC)

```

\newpage

# 5  Summary and Conclusions
The sex ratio of turtles can be influenced by temporal factors, although the impact is generally small. While the distribution of sex ratios across space does not exhibit any specific pattern, there is a noticeable trend where locations with lower temperatures tend to have a higher proportion of male turtles. Despite this, it appears that neither spatial nor temporal factors are significant determinants of the sex ratio of turtles. The analysis strongly suggests that temperature is the primary determinant. This result is based on the data from 103 species in 12 families. All of them are in the Testudines order. 

The main limitation of our study is that linear regression model may not be the best fit to the data as the trend is more or less polynomial which results in low R-squared values for the linear regression models. Our results may also be limited from the variation of sex ratio among different families and the variation of the amount of data we have for each family. Our data are mainly from north hemisphere which may also affect our results. 

Nevertheless, we have seen a strong relationship between temperature and sex ratio of turtles. As climate change gets worse, the increased temperature can easily harm turtles' population by leading to irregular and potentially lethal incubation conditions (NOAA, 2023). Research on how to mitigate the impact of climate change on turtles population and conservation action should be done in the very near future. 

[Smiling red-eared turtles](../Output/Red-Eared-Slider-Turtle.jpeg)

\newpage

# 6  References

Bull, J. J., & Vogt, R. C. (1979). Temperature-dependent sex determination in turtles. Science, 1186-1188.

Krueger, C. J., & Janzen, F. J. (2022). ROSIE, a database of reptilian offspring sex ratios and sex-determining mechanisms, beginning with Testudines. Scientific Data, 9(1), 22.

Yntema, C. L. (1976). Effects of incubation temperatures on sexual differentiation in the turtle, Chelydra serpentina. Journal of Morphology, 150(2), 453-461.

! <https://oceanservice.noaa.gov/facts/temperature-dependent.html>

Photo credit: <https://scitechdaily.com/why-does-temperature-determine-the-sex-of-turtles/>

<https://www.pinterest.jp/pin/61783826112891810/>
